{
  "module": "core",
  "description": "Core workflow engine, back-pressure, git, and document management",
  "status": "complete",
  "components": {
    "workflow_engine": {
      "status": "complete",
      "implementation": "WorkflowEngine (Stateless state machine)",
      "tests": "WorkflowEngineTests (20 tests)",
      "jobs": [
        "JOB-059"
      ]
    },
    "codebase_state_assessor": {
      "status": "complete",
      "implementation": "CodebaseStateAssessor",
      "tests": "CodebaseStateAssessorTests (16 tests)",
      "jobs": [
        "JOB-060"
      ]
    },
    "quality_gate_guardrail": {
      "status": "complete",
      "implementation": "QualityGateGuardrail + GuardrailPipeline",
      "tests": "QualityGateGuardrailTests (9 tests)",
      "jobs": [
        "JOB-065"
      ]
    },
    "git_cli_service": {
      "status": "complete",
      "implementation": "GitCliService (Process-based)",
      "tests": "GitCliServiceTests (7 tests)",
      "jobs": [
        "JOB-070"
      ],
      "notes": " GetCurrentBranchAsync added to IGitService for TUI-02."
    },
    "git_workflow_service": {
      "status": "complete",
      "implementation": "GitWorkflowService",
      "tests": "GitWorkflowServiceTests (25 tests)",
      "jobs": [
        "JOB-070"
      ],
      "notes": "Auto-commit on task completion, branch-per-module (lopen/{module}), conventional commit messages"
    },
    "lopen_revert": {
      "status": "complete",
      "implementation": "RevertService + RevertResult + SessionState.LastTaskCompletionCommitSha",
      "tests": "RevertServiceTests (11 tests)",
      "jobs": [
        "JOB-071"
      ],
      "notes": "Rolls back to specified commit SHA via git reset --hard. SessionState tracks LastTaskCompletionCommitSha. Handles git disabled, failures, exceptions."
    },
    "acceptance_criteria_tests": {
      "status": "complete",
      "implementation": "CoreAcceptanceCriteriaTests (28 tests mapping all 24 ACs)",
      "tests": "CoreAcceptanceCriteriaTests.cs",
      "jobs": [
        "JOB-075"
      ],
      "notes": "Explicit test mapping for AC-01 through AC-24 per SPECIFICATION.md"
    },
    "output_renderer": {
      "status": "complete",
      "implementation": "IOutputRenderer interface + HeadlessRenderer (plain text)",
      "tests": "HeadlessRendererTests (7 tests) + ServiceCollectionExtensionsTests (1 test)",
      "jobs": [
        "JOB-077"
      ],
      "notes": "HeadlessRenderer writes to stdout/stderr. PromptAsync returns null (non-interactive). Registered as default in DI via TryAddSingleton."
    },
    "di_registration": {
      "status": "complete",
      "implementation": "AddLopenCore() registers IWorkflowEngine, IStateAssessor, IPhaseTransitionController",
      "tests": "ServiceCollectionExtensionsTests (14 tests)",
      "jobs": [
        "JOB-001"
      ],
      "notes": "IStateAssessor and IWorkflowEngine conditional on projectRoot (depend on IFileSystem, IModuleScanner). IPhaseTransitionController registered unconditionally."
    },
    "orchestration_loop": {
      "status": "complete",
      "implementation": "WorkflowOrchestrator (IWorkflowOrchestrator) + OrchestrationResult",
      "tests": "WorkflowOrchestratorTests (21 tests)",
      "jobs": [
        "JOB-002"
      ],
      "notes": "Drives assess → guardrails → LLM invoke → transition loop. Human gate for spec step. Registered in DI via AddLopenCore(). CORE-25: Tools now registered with SDK SessionConfig via ToolConversion bridge."
    },
    "auto_transitions": {
      "status": "complete",
      "implementation": "WorkflowOrchestrator auto-transition checks in RunStepAsync",
      "tests": "WorkflowOrchestratorTests (2 new tests for Repeat→ModuleComplete and Repeat→Assess)",
      "jobs": [
        "JOB-014",
        "JOB-015"
      ],
      "notes": "Human gate for spec approval. Auto-transition from Repeat→Complete when no more components. Planning→Building via PhaseTransitionController."
    },
    "drift_detection_wiring": {
      "status": "complete",
      "implementation": "ISpecificationDriftService + SpecificationDriftService in Lopen.Core/Documents. Wired into WorkflowOrchestrator.RunStepAsync step 2.",
      "tests": "SpecificationDriftServiceTests (9 tests) + 2 orchestrator drift tests",
      "jobs": [
        "JOB-013"
      ],
      "notes": "Bridges IDriftDetector with in-memory section hash cache. Renders drift warnings to user via IOutputRenderer."
    },
    "git_workflow_wiring": {
      "status": "complete",
      "implementation": "IGitWorkflowService wired into ToolHandlerBinder (CommitTaskCompletion) and WorkflowOrchestrator (EnsureModuleBranch)",
      "tests": "ToolHandlerBinderTests (4 new git tests) + WorkflowOrchestratorTests (2 branch tests)",
      "jobs": [
        "JOB-016",
        "JOB-017"
      ],
      "notes": "CommitTaskCompletionAsync called after verified task completion with module/component params. EnsureModuleBranchAsync called before engine init in RunAsync."
    },
    "autosave_wiring": {
      "status": "complete",
      "implementation": "IAutoSaveService wired into WorkflowOrchestrator RunAsync loop",
      "tests": "WorkflowOrchestratorTests (3 new autosave tests)",
      "jobs": [
        "JOB-019"
      ],
      "notes": "Auto-saves on step completion, task failure, user pause, phase transition, cancellation. Exception-safe."
    },
    "session_resume_wiring": {
      "status": "complete",
      "implementation": "ISessionManager wired into WorkflowOrchestrator.RunAsync for session resume/create",
      "tests": "WorkflowOrchestratorTests (2 new session tests)",
      "jobs": [
        "JOB-020"
      ],
      "notes": "Checks for latest session by module. Resumes if incomplete. Creates new session otherwise."
    },
    "token_metrics_wiring": {
      "status": "complete",
      "implementation": "ITokenTracker wired into WorkflowOrchestrator for token recording + SessionMetrics persistence via AutoSaveService",
      "tests": "WorkflowOrchestratorTests (2 new token tests)",
      "jobs": [
        "JOB-021"
      ],
      "notes": "RecordUsage called after LLM invocation. GetSessionMetrics mapped to SessionMetrics for auto-save. TUI pipeline: TopPanelData already has fields, data flows via orchestrator."
    },
    "prompt_injection": {
      "status": "complete",
      "implementation": "WorkflowOrchestrator accepts userPrompt and passes to IPromptBuilder via contextSections",
      "tests": "RunAsync_PassesUserPromptToPromptBuilder, RunStepAsync_PassesUserPromptToPromptBuilder, RunAsync_WithNullPrompt_PassesNullContextSections",
      "jobs": [
        "JOB-031"
      ],
      "notes": "userPrompt stored as _userPrompt field, passed as contextSections[user_prompt] to BuildSystemPrompt"
    },
    "module_scanner_wiring": {
      "status": "complete",
      "implementation": "IModuleScanner used in ModuleLister, CodebaseStateAssessor, SpecificationDriftService, PhaseCommands",
      "tests": "Existing ModuleScannerTests + integration through other tests",
      "jobs": [
        "JOB-067"
      ],
      "notes": "Already wired upstream - orchestrator receives moduleName as parameter"
    },
    "state_assessor_wiring": {
      "status": "complete",
      "implementation": "IStateAssessor wired into WorkflowEngine.InitializeAsync and WorkflowOrchestrator for HasMoreComponentsAsync",
      "tests": "WorkflowEngineTests + WorkflowOrchestratorTests",
      "jobs": [
        "JOB-068"
      ],
      "notes": "GetCurrentStepAsync called on engine init, HasMoreComponentsAsync in orchestrator transitions"
    },
    "task_status_gate_wiring": {
      "status": "complete",
      "implementation": "ITaskStatusGate wired into ToolHandlerBinder. ValidateCompletion called before allowing task completion, falls back to direct tracker check.",
      "tests": "HandleUpdateTaskStatus_UsesTaskStatusGateWhenProvided, HandleUpdateTaskStatus_TaskStatusGateAllowed_Succeeds",
      "jobs": [
        "JOB-069"
      ],
      "notes": "Optional dependency - when present, replaces inline verification tracker check"
    },
    "plan_manager_wiring": {
      "status": "complete",
      "implementation": "IPlanManager wired into ToolHandlerBinder. UpdateCheckboxAsync called after task completion.",
      "tests": "HandleUpdateTaskStatus_CallsPlanManagerOnCompletion, HandleUpdateTaskStatus_SkipsPlanManagerWhenNotProvided",
      "jobs": [
        "JOB-070",
        "JOB-079"
      ],
      "notes": "Optional dependency - updates plan.md checkbox when task marked complete IPlanManager now wired into WorkflowOrchestrator. Plan content persisted after BreakIntoTasks. Appends to existing plan. Graceful fallback when null. DI resolves optionally."
    },
    "failure_handler_wiring": {
      "status": "complete",
      "implementation": "IFailureHandler wired into WorkflowOrchestrator. On step failure: RecordFailure() → SelfCorrect continues loop, PromptUser prompts user or auto-continues in unattended mode, Block interrupts. ResetFailureCount on success.",
      "tests": "WorkflowOrchestratorTests (12 failure handler tests) + ServiceCollectionExtensionsTests (2 DI tests)",
      "jobs": [
        "JOB-071",
        "JOB-072"
      ],
      "notes": "CORE-21: SelfCorrect on single failure. CORE-22: PromptUser at threshold prompts via IOutputRenderer.PromptAsync — user confirms y/yes to continue (resets count), declines/null to interrupt. Unattended mode suppresses prompt and continues. WorkflowOptions passed to orchestrator via DI."
    },
    "budget_enforcement_wiring": {
      "status": "complete",
      "implementation": "WorkflowOrchestrator.CheckBudgetAsync() — IBudgetEnforcer + ITokenTracker pre-invocation check",
      "tests": "WorkflowOrchestratorTests (10 budget tests) + ServiceCollectionExtensionsTests (1 DI test)",
      "jobs": [
        "JOB-084"
      ],
      "notes": "Budget check before each LLM invocation. Handles Ok/Warning/ConfirmationRequired/Exceeded. Auto-saves on halt for session resume."
    },
    "critical_error_handling": {
      "status": "complete",
      "implementation": "IsCriticalException detection in WorkflowOrchestrator, StepResult.CriticalFailure, OrchestrationResult.CriticalError",
      "tests": "WorkflowOrchestratorTests (12 critical error tests) + CoreAcceptanceCriteriaTests (3 AC-23 tests)",
      "jobs": [
        "JOB-073"
      ],
      "notes": "Critical exceptions (IOException, UnauthorizedAccessException, OutOfMemoryException, SecurityException) bypass self-correction and block immediately via RecordCriticalError."
    },
    "pause_controller": {
      "status": "complete",
      "implementation": "IPauseController + PauseController (thread-safe SemaphoreSlim + lock). Wired into WorkflowOrchestrator pause gate and TuiApplication.TogglePause.",
      "tests": "PauseControllerTests (14 tests) + WorkflowOrchestratorTests (5 pause integration tests)",
      "jobs": [
        "JOB-037"
      ],
      "notes": "Pause gate in orchestrator's main loop: checks IsPaused, auto-saves with UserPause, renders Paused/Resumed messages, blocks via WaitIfPausedAsync. DI registered as singleton."
    },
    "module_selection": {
      "status": "complete",
      "implementation": "IModuleSelectionService + ModuleSelectionService. Lists modules via IModuleLister with status indicators (○/◐/●) and progress counts. Selection by number or name. Wired into PhaseCommands.ResolveModuleNameAsync as fallback.",
      "tests": "ModuleSelectionServiceTests (17 tests)",
      "jobs": [
        "JOB-074"
      ],
      "notes": "DI registered in AddLopenCore(). Headless mode gracefully returns null (PromptAsync returns null). Interactive mode prompts user with numbered list."
    },
    "tool_handler_binding": {
      "status": "complete",
      "implementation": "IToolHandlerBinder wired into WorkflowOrchestrator.RunAsync — BindAll called after engine init",
      "tests": "ToolBindingIntegrationTests (1 test) + ServiceCollectionExtensionsTests (1 DI test)",
      "jobs": [
        "JOB-126"
      ],
      "notes": "Fixed CORE-25: BindAll() was only called in tests, never in production. Now called after InitializeAsync before LLM loop."
    },
    "guardrail_di_registration": {
      "status": "complete",
      "implementation": "ResourceLimitGuardrail + ChurnDetectionGuardrail + PassThroughGuardrail registered in DI",
      "tests": "PassThroughGuardrailTests (3 tests) + ServiceCollectionExtensionsTests (3 DI tests)",
      "jobs": [
        "JOB-127"
      ],
      "notes": "Fixed CORE-11/12: ResourceLimitGuardrail conditional on ITokenTracker + BudgetOptions.PremiumRequestBudget > 0 (falls back to PassThroughGuardrail). ChurnDetectionGuardrail uses WorkflowOptions.FailureThreshold."
    },
    "tool_handler_binder_wiring": {
      "status": "complete",
      "implementation": "WorkflowOrchestrator.RunAsync calls ToolHandlerBinder.BindAll()",
      "tests": "WorkflowOrchestratorTests (RunAsync_WithToolHandlerBinder_CallsBindAll, RunAsync_WithoutToolHandlerBinder_CompletesWithoutError)",
      "jobs": [
        "JOB-126",
        "JOB-128"
      ],
      "notes": "BindAll called at line 158, null-conditional for optional injection"
    },
    "failure_intervention": {
      "status": "complete",
      "spec_ref": "CORE-22",
      "implementation": "FailureHandler + ChurnDetectionGuardrail wired into WorkflowOrchestrator",
      "tests": "FailureHandlerTests, WorkflowOrchestratorTests, FailureModalWiringTests",
      "jobs": [
        "JOB-133"
      ],
      "notes": "Repeated task failures at threshold prompt user intervention"
    },
    "resource_tracker": {
      "status": "complete",
      "files": [
        "src/Lopen.Core/Documents/IResourceTracker.cs",
        "src/Lopen.Core/Documents/ResourceTracker.cs"
      ],
      "tests": "ResourceTrackerTests (11 tests: discovery, content loading, error handling)",
      "job": "JOB-170",
      "notes": "Discovers SPECIFICATION.md, RESEARCH.md, RESEARCH-*.md, and plan.md for active module. Uses IFileSystem and StoragePaths for testability."
    },
    "orchestrator_retry_guardrail_integration": {
      "status": "complete",
      "implementation": "OrchestratorRetryGuardrailIntegrationTests in Lopen.Core.Tests",
      "tests": "5 tests: pass/block/warn guardrails + model fallback + all-models-fail",
      "jobs": [
        "JOB-016"
      ],
      "notes": "Uses real GuardrailPipeline and RetryingLlmService (via InternalsVisibleTo) with fake inner ILlmService. Added Lopen.Llm project reference to Core.Tests."
    }
  },
  "last_updated": "2026-02-18T07:50:00Z"
}
